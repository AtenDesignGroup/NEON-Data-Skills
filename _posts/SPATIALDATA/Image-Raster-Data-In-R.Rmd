---
layout: post
title: "Image Raster Data in R - An Intro"
date:   2015-05-18
authors: [Leah A. Wasser]
dateCreated:  2015-05-18
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
categories: [self-paced-tutorial]
category: self-paced-tutorial
tags: [hyperspectral-remote-sensing, R, spatial-data-gis, remote-sensing]
packagesLibraries: [raster, sp, rgdal]
mainTag: spatial-data-gis
description: "This tutorial explains the fundamental principles, functions and 
metadata that you need to work with raster data, in image format, in R. Topics 
include raster stacks, raster bricks, plotting RGB images and exporting an RGB 
image to a GeoTIFF."
code1: 
image:
  feature: lidar_GrandMesa.png
  credit: LiDAR data collected over Grand Mesa, Colorado - National Ecological Observatory Network (NEON)
  creditlink:
permalink: /R/Image-Raster-Data-In-R/
code1: R/Image-Raster-Data-In-R.R
comments: true
---

{% include _toc.html %}


This tutorial will walk you through the fundamental principles of working 
with image raster data in R.

**R Skill Level:** Intermediate

<div id="objectives" markdown="1">

# Tutorial Objectives
After completing this activity, you will be able to:

* Import multiple image rasters and create a stack of rasters.
* Plot three band RGB images in R.
* Export single band and multiple band image rasters in R.


## Things Youâ€™ll Need To Complete This Tutorial
You will need the most current version of `R` and, preferably, `RStudio` loaded
on your computer to complete this tutorial.

### Install R Packages

* **raster:** `install.packages("raster")`
* **rgdal:** `install.packages("rgdal")`
* **sp:** `install.packages("sp")`

[More on Packages in R - Adapted from Software Carpentry.]({{site.baseurl}}/R/Packages-In-R/)

### Download Data

{% include/dataSubsets/_data_Field-Site-Spatial-Data.html %}

This data download contains several files. You will only need the RGB .tif files
for this tutorial. The path to this file is: NEON-DS-Field-Site-Spatial-Data/SJER/RGB/* . 
The other data files in the downloaded data directory are used for related tutorials. 
You should set your working directory to the SJER directory to follow the code 
exactly. 

## Recommended Reading

You may benefit from reviewing these related tutorials prior to this tutorial: 

* <a href="{{ site.baseurl }}/GIS-spatial-data/Working-With-Rasters/">
The Relationship Between Raster Resolution, Spatial Extent & Number of Pixels - in R.</a>
* <a href="{{ site.baseurl }}/R/Raster-Data-In-R/">
Please read "Raster Data in R - The Basics.</a>
* <a href="http://cran.r-project.org/web/packages/raster/raster.pdf" target="_blank">
The `raster` R package documentation.</a>

</div>

## Raster Data
Raster or "gridded" data are data that are saved in pixels. In the spatial world, 
each pixel represents an area on the Earth's surface. An color image raster is 
a bit different from other rasters in that it has multiple bands. Each band 
represents reflectance values for a particular color or spectra of light. If the 
image is RGB, then the bands are in the red, green and blue portions of the 
electromagnetic spectrum. These colors together create what we know as a full 
color image.

<figure>
   <img src="{{ site.baseurl }}/images/hyperspectral/RGBImage_2.png">
   <figcaption>A color image at the NEON San Joaquin Experimental Range (SJER) 
   field site in California. Each pixel in the image represents the combined
   reflectance in the red, green and blue portions of the electromagnetic spectrum.
   Source: National Ecological Observatory Network (NEON)</figcaption>
</figure>

## Work with Multiple Rasters

In [a previous tutorial]({{ site.baseurl }}/R/Raster-Data-In-R/), we loaded a 
single raster into R. We made sure we knew the `CRS` 
(coordinate reference system) and extent of the dataset among other key metadata 
attributes. This raster was a Digital Elevation Model so there was only a single
raster that represented the ground elevation in each pixel. When we work with 
color images, there are multiple rasters to represent each band. Here we'll learn
to work with multiple rasters together. 

### Raster Stacks

A raster stack is a collection of raster layers. Each raster layer in the raster 
stack needs to have the same 

* projection (CRS), 
* spatial extent and 
* resolution. 

You might use raster stacks for different reasons. For instance, you might want to 
group a time series of rasters representing precipitation or temperature into 
one R object. Or, you might want to create a color images from red, green and 
blue band derived rasters.

In this tutorial, we will stack three bands from a multi-band image together to 
create a composite RGB image.

First let's load the R packages that we need: `sp` and `raster`. 

``` {r set-up}

# load the raster, sp, and rgdal packages
library(raster)
library(sp)
library(rgdal)

# set the working directory to the data
#setwd("pathToDirHere")
```

Next, let's create a raster stack with bands representing red (`band19`), green 
(`band34`) and blue (`band58`). This can be done individually: 

``` {r import-tiffs}

# import tiffs
band19 <- "RGB/band19.tif"
band34 <- "RGB/band34.tif"
band58 <- "RGB/band58.tif"
```

Note that if we wanted to create a stack from all the files in a directory (folder)
you can easily do this with the `list.files()` function. We would use 
`full.names=TRUE` to ensure that R will store the directory path in our list of
rasters.

``` {r list-files}
# create list of files to make raster stack
rasterlist1 <-  list.files('RGB', full.names=TRUE)
```

Or if your directory is consistes of some .tif files and other file types you 
don't want in your stack you can ask R to only list those files with a .tif 
extension.

```{r list-files-tif}
rasterlist2 <-  list.files('RGB', full.names=TRUE, pattern="tif") 
```

Back to creating our raster stack with three bands.  We only want three of the 
bands in the RGB directory and not the fourth `band90`, so will create the stack
from the bands we loaded individually. We do this with the `stack()` function. 

``` {r r-stack}
# create raster stack
rgbRaster <- stack(band19,band34,band58)

# example syntax for stack from a list
#rstack1 <- stack(rasterlist1)
```

This has now created a stack of rasters three thick. Let's view them. 

``` {r view-stack}
# check attributes
rgbRaster

# plot stack
plot(rgbRaster)

```

From the attributes we see the CRS, resolution, and extent of all three rasters. 
The we can see each raster plotted. 


## Plot an RGB Image

You can plot an RGB image from a raster `stack`. You need to specify the order of the bands when you do this. In our raster stack, band 19 which is the blue band, is first in the list, whereas band 58 which is the red band is last. Thus the order is 3,2,1 to ensure the red band is rendered first as red. 

	#plot an RGB version of the stack
	plotRGB(rgbRaster,r=3,g=2,b=1, scale=800, stretch = "Lin")

<figure>
    <a href="{{ site.baseurl }}/images/spatialData/RGBRaster_SJER.png"><img src="{{ site.baseurl }}/images/spatialData/RGBRaster_SJER.png"></a>
<figcaption>To plot an RGB image in R, you need to specify which rasters to render on the red, green and blue bands. </figcaption>
</figure>



## Explore Raster Values - Histograms
You can also explore the data.


	#look at histogram of reflectance values for all rasters
	hist(rgbRaster)


<figure>
   <a href="{{ site.baseurl }}/images/spatialData/RGBhist.png"><img src="{{ site.baseurl }}/images/spatialData/RGBhist.png"></a>
 <figcaption>Histogram of reflectance values for each raster in the raster stack.</figcaption>
</figure>

	#remember that crop function? You can crop all rasters within a raster stack too
	#finally you can crop all rasters within a raster stack!
	rgbCrop <- c(256770.7,256959,4112140,4112284)
	rgbRaster_crop <- crop(rgbRaster, rgbCrop)
	plot(rgbRaster_crop)

<figure>
   <a href="{{ site.baseurl }}/images/spatialData/cropRaster2.png"><img src="{{ site.baseurl }}/images/spatialData/cropRaster2.png"></a>
 <figcaption>Cropped rasters in the raster stack.</figcaption>
</figure>


## Raster Bricks in R
Now we have a list of rasters in a stack. These rasters are all the same extent CRS and resolution but a raster brick will create one raster object in R that contains all of the rasters we can use this object to quickly create RGB images. Raster bricks are more efficient objects to use when processing larger datasets. This is because the computer doesn't have to spend energy finding the data - it is contained within the object.

	#create raster brick
	RGBbrick <- brick(rgbRaster)
	plotRGB(RGBbrick,r=3,g=2,b=1, scale=800, stretch = "Lin")
	
While the brick might seem similar to the stack, we can see that it's very different when we look at the size of the object.	
	
	#the brick contains ALL of the data stored in one object
	#the stack contains links or references to the files stored on your computer
	object.size(rgbBrick)
	
Output

	> 5759448 bytes	
	
View the size of the stack:
	
	object.size(rgbRaster)

Output:

	> 40408 bytes
	
	
## Write a raster to a Geotiff File in R

We can write out the raster in tiff format as well. When we do this it will copy the CRS, extent and resolution information so the data will read properly into a GIS as well. Note that this writes the raster in the order they are in - in the stack. In this case, the blue (band 19) is first but it's looking for the red band first (RGB). One way around this is to generate a new raster stack with the rasters in the proper order - red, green and blue format.

	#Make a new stack in the order we want the data in: 
	finalRGBstack <- stack(rgbRaster$band58,rgbRaster$band34,rgbRaster$band19)
	#write the geotiff - change overwrite=TRUE to overwrite=FALSE if you want to make sure you don't overwrite your files!
	writeRaster(finalRGBstack,"rgbRaster.tif","GTiff", overwrite=TRUE)

## Import A Multi-Band Image into R
You can import a multi-band image into R too. To do this, you import the file as a stack rather than a raster (which brings in just one band). Let's import the raster than we just created above.

	#Import Multi-Band raster
	newRaster <- stack("rgbRaster.tif") 
	#then plot it
	plot(newRaster)
	plotRGB(newRaster,r=1,g=2,b=3, scale=800, stretch="lin")

## Challenge 


1. A color infrared image is a combination of the gree, red and near-infrared bands. In our case gree <- band 34, red <- band 58 and near-infrared <- band90. Using the same band90 raster that you fixed in step one above, create a color infrared image. HINT: when you use the plotRGB function, you'll map the bands as follows: blue=band34, green=band58, red=band90. Export your results as a geotiff.
