---
title: "Example workflow for processing NEON eddy-covariance turbulence data with eddy4R-Docker 0.2.0"
author: "David Durden, Stefan Metzger, Natchaya Pingintha-Durden, Claire Lunch, Megan Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example workflow for processing NEON eddy-covariance turbulence data with eddy4R-Docker 0.2.0}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## 0. Install and set up

This vignette assumes you are working with eddy4R within the Docker 
environment established by NEON. To get set up in that environment, 
follow the instructions <a href="https://github.com/NEONScience/NEON-Data-Skills/blob/fbd76ce778bc369fa9b94b7751546abb1ae56073/tutorials/R/eddy4r/dockerEddy4r.md" target="_blank">here</a>.
[CKL: Megan, I put a link to the page on GitHub, because I don't think we've 
put this up on the website yet]

At the end of those instructions, you should have an RStudio 
environment running within Docker. Use that workspace for this 
vignette.

## 1. Install packages and set up environment

First, check for required packages and install any that aren't 
already installed. Once all required packages are installed, 
load them into the environment.

Throughout this vignette, we use the `package::function()` 
syntax to explicitly refer to functions. This is done to avoid any 
possibility of ambiguity, in case there are functions in 
different packages with the same name.


```{r pack-install}

packReq <- c("DataCombine", "eddy4R.base", "eddy4R.qaqc",  
             "ff", "ffbase", "methods", "rhdf5","splus2R")
base::lapply(packReq, function(x) {
  print(x)
  if(base::require(x, character.only = TRUE) == FALSE) {
    utils::install.packages(x)
    base::library(x, character.only = TRUE)
  }})
base::rm(packReq)

```


## 2. Set environment variables

Here we set file paths and basic input parameters as environment 
variables for convenience.

```{r env-vars}

# File path for the directory containing input L0' data
base::Sys.setenv("DIRINP" = "/home/eddy/inpExmp") 

# File path for outputs
base::Sys.setenv("DIROUT" = "/home/eddy/out")

# Date(s) of the input data, specified here for the output file name
base::Sys.setenv("DATEOUT" = "2017-09-01")

# NEON domain, site, and data product ID of the input data
# for the output file name:
# Domain 10 = D10
# Central Plains Experimental Range = CPER
# Bundled eddy covariance data = 00200.001
base::Sys.setenv("FILEOUTBASE" = "NEON.D10.CPER.00200.001")

# Flag to indicate to the eddy4R.base::def.para.flow() 
# function that the variables above can be found as 
# environment variables, instead of provided as function 
# inputs
base::Sys.setenv("METHPARAFLOW" = "EnvVar")

```

## 3. Read in metadata

Pass along the environment variables defined in section 2, 
then read in additional parameters from the HDF5 file.

```{r metadata}

# In this section, define and/or read in a number of terms and 
# parameters.

# Start with an empty list of parameters
Para <- base::list()

# Use the def.para.flow() function to specify the metadata are stored 
# in environment variables, and give file paths to input and output.
# You will see a number of warning messages in response to this line, 
# but if you can proceed with the next several commands, don't worry 
# about the warnings here.
# [CKL: Dave, you said the data are in the build. What are the 
# dropbox links for?]
Para$Flow <- eddy4R.base::def.para.flow(MethParaFlow = "EnvVar",
                                        UrlInpRefe = 
                                          "https://www.dropbox.com/s/d9ggsvepiypi9hb/inpRefe_20171220.zip?dl=1",
                                        UrlOutRefe = 
                                          "https://www.dropbox.com/s/xf2viykgzajdfic/outRefe_20171220.zip?dl=1")

# Get the NEON-specific 4-letter code for the site location (Loc) 
# from the dp0p input file   
Para$Flow$Loc <- eddy4R.base::def.para.site(FileInp = Para$Flow$DirFilePara)$Loc 

# Get the level of the tower top (LvlTowr) from the dp0p input file 
Para$Flow$LvlTowr <- eddy4R.base::def.para.site(FileInp = Para$Flow$DirFilePara)$LvlTowr

# For each variable to be written out, set the ??? parameters.
# Variables:
#   amrs: Attitude Motion Reference System
#   co2turb: Turbulent CO2 flux
#   h2oTurb: Turbulent H2O flux
#   soni: Windspeed and direction from sonic anemometer
# Parameters:
#   PrdIncrAgrDflt: [CKL: ???]
#   PrdWndwAgrDflt: [CKL: ???]
for(idx in c("amrs", "co2Turb", "h2oTurb", "soni")) {
  
  Para$Flow$dp01[[idx]] <- eddy4R.base::def.hdf5.read.para(
    DirFileParaLoca = Para$Flow$DirFilePara,
    GrpName = paste0("/", Para$Flow$Loc, "/dp01/data/", idx),
    SetPara = c("PrdIncrAgrDflt", "PrdWndwAgrDflt")
  )
  
}

# AngEnuXaxs: Angle of x axis [CKL: relative to what?]
# AngEnuYaxs: Angle of y axis [CKL: relative to what?]
# Ofst: Offset [CKL: of what relative to what?]
# ZoneTime: Time zone of data collection
Para$Sci <- eddy4R.base::def.hdf5.read.para(
  DirFileParaLoca = Para$Flow$DirFilePara,
  GrpName = Para$Flow$Loc,
  SetPara = c("Pf$AngEnuXaxs", "Pf$AngEnuYaxs", "Pf$Ofst", "ZoneTime")
)

# MaxReso: Maximum resolution [CKL: of what?]
# NumBin: Number of bins [CKL: bins for what?]
# NumWndw: Number of windows [CKL: ?]
Para$Sci$dp01 <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp01"),
      SetPara = c("Dspk$Br86$MaxReso", "Dspk$Br86$NumBin", "Dspk$Br86$NumWndw")
)

# In the next 3 commands, define the sampling frequency (FreqSamp) 
# of the STOPPED HERE
Para$Sci$dp0p$irgaTurb <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/irgaTurb"),
      SetPara = c("FreqSamp")
)
      
      Para$Sci$dp0p$mfcSampTurb <- def.hdf5.read.para(
        DirFileParaLoca = Para$Flow$DirFilePara,
        GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/mfcSampTurb"),
        SetPara = c("FreqSamp")
      )
      
      Para$Sci$dp0p$valvValiNemaTurb <- def.hdf5.read.para(
        DirFileParaLoca = Para$Flow$DirFilePara,
        GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/valvValiNemaTurb"),
        SetPara = c("FreqSamp")
      )
      
      Para$Sci$dp0p$soni <- def.hdf5.read.para(
        DirFileParaLoca = Para$Flow$DirFilePara,
        GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/soni"),
        SetPara = c("AngNedZaxs","FreqSamp")
      )
      
      Para$Sci$dp0p$amrs <- def.hdf5.read.para(
        DirFileParaLoca = Para$Flow$DirFilePara,
        GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/amrs"),
        SetPara = c("FreqSamp")
      )

```







[CKL: everything below comes with the vignette template, I 
kept it for my own reference, will delete in final version]

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
