---
title: "Example workflow for processing NEON eddy-covariance turbulence data with eddy4R-Docker 0.2.0"
author: "David Durden, Stefan Metzger, Natchaya Pingintha-Durden, Claire Lunch, Megan Jones"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example workflow for processing NEON eddy-covariance turbulence data with eddy4R-Docker 0.2.0}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## 0. Install and set up

This vignette assumes you are working with eddy4R within the Docker 
environment established by NEON. To get set up in that environment, 
follow the instructions <a href="https://github.com/NEONScience/NEON-Data-Skills/blob/fbd76ce778bc369fa9b94b7751546abb1ae56073/tutorials/R/eddy4r/dockerEddy4r.md" target="_blank">here</a>.
[CKL: Megan, I put a link to the page on GitHub, because I don't think we've 
put this up on the website yet]

At the end of those instructions, you should have an RStudio 
environment running within Docker. Use that workspace for this 
vignette.

## 1. Install packages and set up environment

First, check for required packages and install any that aren't 
already installed. Once all required packages are installed, 
load them into the environment.

Throughout this vignette, we use the `package::function()` 
syntax to explicitly refer to functions. This is done to avoid any 
possibility of ambiguity, in case there are functions in 
different packages with the same name.


```{r pack-install}

packReq <- c("DataCombine", "eddy4R.base", "eddy4R.qaqc",  
             "ff", "ffbase", "methods", "rhdf5","splus2R")
base::lapply(packReq, function(x) {
  print(x)
  if(base::require(x, character.only = TRUE) == FALSE) {
    utils::install.packages(x)
    base::library(x, character.only = TRUE)
  }})
base::rm(packReq)

```


## 2. Set environment variables

Here we set file paths and basic input parameters as environment 
variables for convenience.

```{r env-vars}

# File path for the directory containing input L0' data
base::Sys.setenv("DIRINP" = "/home/eddy/inpExmp") 

# File path for outputs
base::Sys.setenv("DIROUT" = "/home/eddy/out")

# Date(s) of the input data, specified here for the output file name
base::Sys.setenv("DATEOUT" = "2017-09-01")

# NEON domain, site, and data product ID of the input data
# for the output file name:
# Domain 10 = D10
# Central Plains Experimental Range = CPER
# Bundled eddy covariance data = 00200.001
base::Sys.setenv("FILEOUTBASE" = "NEON.D10.CPER.00200.001")

# Flag to indicate to the eddy4R.base::def.para.flow() 
# function that the variables above can be found as 
# environment variables, instead of provided as function 
# inputs
base::Sys.setenv("METHPARAFLOW" = "EnvVar")

```

## 3. Read in metadata

Pass along the environment variables defined in section 2, 
then read in additional parameters from the HDF5 file.

```{r metadata}

# In this section, define and/or read in a number of terms and 
# parameters.

# Create an empty list for parameters.
Para <- base::list()

# Use the def.para.flow() function to specify the metadata are stored 
# in environment variables, and give file paths to input and output.
# You will see a number of warning messages in response to this line, 
# but if you can proceed with the next several commands, don't worry 
# about the warnings here.
# [CKL: Dave, you said the data are in the build. What are the 
# dropbox links for?]
Para$Flow <- eddy4R.base::def.para.flow(MethParaFlow = "EnvVar",
                                        UrlInpRefe = 
                                          "https://www.dropbox.com/s/d9ggsvepiypi9hb/inpRefe_20171220.zip?dl=1",
                                        UrlOutRefe = 
                                          "https://www.dropbox.com/s/xf2viykgzajdfic/outRefe_20171220.zip?dl=1")

# Get the NEON-specific 4-letter code for the site location (Loc) 
# from the dp0p input file   
Para$Flow$Loc <- eddy4R.base::def.para.site(FileInp = Para$Flow$DirFilePara)$Loc 

# Get the level of the tower top (LvlTowr) from the dp0p input file 
Para$Flow$LvlTowr <- eddy4R.base::def.para.site(FileInp = Para$Flow$DirFilePara)$LvlTowr

# Use the def.hdf5.read.para() function to extract parameters 
# from the metadata in the input file and assign them to the 
# parameter list.

# For each variable to be written out, set the ??? parameters.
# Variables:
#   amrs: Attitude Motion Reference System
#   co2turb: Turbulent CO2 flux
#   h2oTurb: Turbulent H2O flux
#   soni: Windspeed and direction from sonic anemometer
# Parameters:
#   PrdIncrAgrDflt: [CKL: ???]
#   PrdWndwAgrDflt: [CKL: ???]
for(idx in c("amrs", "co2Turb", "h2oTurb", "soni")) {
  
  Para$Flow$dp01[[idx]] <- eddy4R.base::def.hdf5.read.para(
    DirFileParaLoca = Para$Flow$DirFilePara,
    GrpName = paste0("/", Para$Flow$Loc, "/dp01/data/", idx),
    SetPara = c("PrdIncrAgrDflt", "PrdWndwAgrDflt")
  )
  
}

# AngEnuXaxs: Angle of x axis [CKL: relative to what?]
# AngEnuYaxs: Angle of y axis [CKL: relative to what?]
# Ofst: Offset [CKL: of what relative to what?]
# ZoneTime: Time zone of data collection
Para$Sci <- eddy4R.base::def.hdf5.read.para(
  DirFileParaLoca = Para$Flow$DirFilePara,
  GrpName = Para$Flow$Loc,
  SetPara = c("Pf$AngEnuXaxs", "Pf$AngEnuYaxs", "Pf$Ofst", "ZoneTime")
)

# MaxReso: Maximum resolution [CKL: of what?]
# NumBin: Number of bins [CKL: bins for what?]
# NumWndw: Number of windows [CKL: ?]
Para$Sci$dp01 <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp01"),
      SetPara = c("Dspk$Br86$MaxReso", "Dspk$Br86$NumBin", "Dspk$Br86$NumWndw")
)

# In the next 5 commands, get the sampling frequency (FreqSamp) 
# of each instrument from the parameters in the input file:
# irgaTurb: Turbulent flux gas analyzer
# mfcSampTurb: Mass flow controller
# valvValiNemaTurb: [CKL: ???]
# soni, amrs: See above
Para$Sci$dp0p$irgaTurb <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/irgaTurb"),
      SetPara = c("FreqSamp")
)

Para$Sci$dp0p$mfcSampTurb <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/mfcSampTurb"),
      SetPara = c("FreqSamp")
)

Para$Sci$dp0p$valvValiNemaTurb <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/valvValiNemaTurb"),
      SetPara = c("FreqSamp")
)

# For the sonic anemometer, also get the angle of the z axis 
# relative to a plumb line (AngNedZaxs) [CKL: is this correct?]
Para$Sci$dp0p$soni <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/soni"),
      SetPara = c("AngNedZaxs","FreqSamp")
)

Para$Sci$dp0p$amrs <- def.hdf5.read.para(
      DirFileParaLoca = Para$Flow$DirFilePara,
      GrpName = paste0("/", Para$Flow$Loc, "/dp0p/data/amrs"),
      SetPara = c("FreqSamp")
)

# [CKL: not sure I understand these next two parameters. 
# After running them, Lag$TimeDiff is still NA.
# If this is something that would be relevant in 
# other circumstances, need to explain here]
Para$Sci$dp01$co2Turb$RtioMoleDryCo2 <- def.hdf5.read.para(
        DirFileParaLoca = Para$Flow$DirFilePara,
        GrpName = paste0("/", Para$Flow$Loc, "/dp01/data/co2Turb/", 
                         Para$Flow$LvlTowr, "_30m/rtioMoleDryCo2"),
        SetPara = c("Lag$TimeDiff")
)

Para$Sci$dp01$h2oTurb$RtioMoleDryH2o <- def.hdf5.read.para(
        DirFileParaLoca = Para$Flow$DirFilePara,
        GrpName = paste0("/", Para$Flow$Loc, "/dp01/data/h2oTurb/", 
                         Para$Flow$LvlTowr, "_30m/rtioMoleDryH2o"),
        SetPara = c("Lag$TimeDiff")
)

# Create a version label for your outputs, using the 
# current system time
Para$Flow$VersDp <- paste0(Para$Flow$VersDp, "_", 
                           format(Sys.time(), "%Y%m%d_%H%M%S_%Z"))

# Create a list of the sampling frequencies of the essential 
# instruments, extracted from the input data above.
FreqSamp <- list(
  "irgaTurb" = Para$Sci$dp0p$irgaTurb$FreqSamp,
  "mfcSampTurb" = Para$Sci$dp0p$mfcSampTurb$FreqSamp,
  "valvValiNemaTurb" = ifelse(length(as.numeric(Para$Sci$dp0p$valvValiNemaTurb$FreqSamp))==0,
                              0.2, as.numeric(Para$Sci$dp0p$valvValiNemaTurb$FreqSamp)), #[CKL: I modified this, including code as a comment isn't a good practice]
  "soni" = Para$Sci$dp0p$soni$FreqSamp,
  "amrs" = Para$Sci$dp0p$amrs$FreqSamp
)

```

## 4. Variable ranges

Set plausible ranges for the input variables, to be tested on ingest.
Then set paths for the working directory.

```{r range}

# Create an empty list for range values.
Rng <- list()
  
# Set ranges for gas analyzer variables:
# densMoleCo2: CO2 molar density, mol m-3
# densMoleH2o: H2O molar density, mol m-3
# presAtm: Atmospheric pressure, Pa
# presDiff: Difference in pressure from ?? [CKL: ?], Pa
# rtioMoleDryCo2: Mole ratio of CO2 in air, mol mol-1
# rtioMoleDryH2o: Mole ratio of H2O in air, mol mol-1
# tempIn: Temperature of air at inlet, K
# tempOut: Temperature of air at outlet, K
Rng$irgaTurb <- data.frame(
  "densMoleCo2" = c(0,30) * 1e-3,
  "densMoleH2o" = c(0,1500) * 1e-3,
  "presAtm" = c(50,120) * 1e3,
  "presDiff" = c(-10,1) * 1e3,
  "rtioMoleDryCo2" = c(300,450) * 1e-6,
  "rtioMoleDryH2o" = c(0,30) * 1e-3,
  "tempIn" = c(220,330),
  "tempOut" = c(220,330)
)

# Set ranges for sonic anemometer variables:
# veloXaxs: Velocity on the x axis, m s-1
# veloYaxs: Velocity on the y axis, m s-1
# veloZaxs: Velocity on the z axis, m s-1
# veloSoni: Total velocity, m s-1 [CKL: correct?]
Rng$soni <- data.frame(
  "veloXaxs"=c(-50,50),
  "veloYaxs"=c(-50,50),
  "veloZaxs"=c(-10,10),
  "veloSoni"=c(300,400)
)

# Set ranges for attitude and motion reference variables:
# angXaxs: Deviation from the x axis, degree
# angYaxs: Deviation from the y axis, degree
# angZaxs: Deviation from the z axis, degree
Rng$amrs <- data.frame(
  "angXaxs"=c(-360,360),
  "angYaxs"=c(-360,360),
  "angZaxs"=c(-360,360)
)

# Set directories and file paths
# As written, this vignette uses the default paths. To use custom 
# paths, assign the file paths you want to use to the parameters
# Para$Flow$DirWrk, Para$Flow$DirInp, and Para$Flow$DirOut before
# proceeding to the code below.

# Working directory
# Default: use a temporary working directory on Docker filesystem
if(is.na(Para$Flow$DirWrk)) {
  Para$Flow$DirWrk <- tempdir()

  # Optional: create a user-specified working directory, e.g. on host filesystem
  } else {
    dir.create(Para$Flow$DirWrk, recursive = TRUE, showWarnings = FALSE)
  }

# Directory for input data
# Default: use temporary working directory on Docker filesystem
if(is.na(Para$Flow$DirInp)) {
  Para$Flow$DirInp <- paste0(Para$Flow$DirWrk, "/inpRefe")
  
  # Optional: create user-specified input directory
  } else {
    dir.create(Para$Flow$DirInp, recursive = TRUE, showWarnings = FALSE)
  }

# Directory for output data
# Default: use temporary working directory on Docker filesystem
if(is.na(Para$Flow$DirOut)) {
  Para$Flow$DirOut <- paste0(Para$Flow$DirWrk, "/out")
  
  # Optional: create user-specified input directory
  } else {
    dir.create(Para$Flow$DirOut, recursive = TRUE, showWarnings = FALSE)
  }


```

## 5. Read in data!

```{r ingest}

```



[CKL: everything below comes with the vignette template, I 
kept it for my own reference, will delete in final version]

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
