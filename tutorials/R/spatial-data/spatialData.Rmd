---
syncID: 
title: "Access and Work with NEON Geolocation Data"
description: "Use files available on the data portal, the NEON API, and the neonUtilities R package to access the locations of NEON sampling events and infrastructure. Calculate more precise locations for certain sampling types, and reference ground sampling to airborne data."
dateCreated: 2019-09-13
authors: [Claire K. Lunch]
contributors:
estimatedTime: 40 minutes
packagesLibraries: neonUtilities
topics: data-management, rep-sci
languageTool: R
code1: R/
tutorialSeries:
urlTitle: neon-spatial-data-basics

---

This tutorial explores NEON geolocation data. The focus is on the locations 
of NEON observational sampling and sensors; NEON remote sensing data are 
inherently spatial and have dedicated tutorials. This tutorial does include 
guidance in linking locations on the ground to remotely sensed images.

## Setup

We'll need several R packages in this tutorial. Install the packages and 
load the libraries for each:

``` {r setup}

# run once to get the package, and re-run if you need to get updates
install.packages("sp")
install.packages("rgdal")
install.packages("ggplot2")
install.packages("neonUtilities")
install.packages("devtools")
devtools::install_github("NEONScience/NEON-geolocation/geoNEON")

# run every time you start a script
library(sp)
library(rgdal)
library(ggplot2)
library(neonUtilities)
library(geoNEON)

options(stringsAsFactors=F)

```

## Spatial data files

### Site locations

Latitude, longitude, elevation, and some other basic metadata for each site 
are available for download from the <a href="https://www.neonscience.org/field-sites/field-sites-map/list" target="_blank">field sites list page</a> on the NEON website. In this summary by field site, the 
geographic coordinates given for each site correspond to the tower 
location for terrestrial sites, and the center of the permitted reach 
for aquatic sites.

Additional large-scale spatial data files are available on the 
<a href="https://www.neonscience.org/data/spatial-data-maps" target="_blank">spatial data and maps page</a>, primarily as shapefiles. 
Using the domain shapefile and the field sites list, let's make 
a map of NEON site locations.

We'll read in the spatial data using the `rgdal` and `sp` packages 
and plot it using the `ggplot2` package. First, read in the domain 
shapefile:

``` {r domains}

# modify "~/data" to the filepath where you downloaded the shapefile
neon.domains <- readOGR("~/data/NEONDomains_0", layer="NEON_Domains")

# the next two commands convert the shapefile to a format ggplot 
# can use
neon.domains <- SpatialPolygonsDataFrame(gSimplify(neon.domains, tol=0.1, 
                                                 topologyPreserve=TRUE), 
                               data=neon.domains@data)
map <- fortify(neon.domains, region="DomainName")

```

Let's plot the domains without the sites first:

``` {r plot-domains, message=F}

gg <- ggplot() + theme_map()
gg <- gg + geom_map(data=map, map=map,
                    aes(x=long, y=lat, map_id=id, group=group),
                    fill="white", color="black", size=0.3)
gg

```

Now read in the field sites file, and add points to the map for 
each site:

``` {r plot-sites}

# modify "~/data" to the filepath where you downloaded the file
sites <- read.delim("~/data/field-sites.csv", sep=",", header=T)

gg <- gg + geom_point(data=sites, aes(x=Longitude, y=Latitude))
gg

```

And let's color code sites, plotting terrestrial sites in green and 
aquatic sites in blue:

``` {r sites-color}

gg <- gg + geom_point(data=sites, 
                      aes(x=Longitude, y=Latitude, color=Site.Type)) + 
           scale_color_manual(values=c("blue4", "springgreen4", 
                                       "blue", "olivedrab"),
                              name="",
                              breaks=unique(sites$Site.Type))
gg

```


### Terrestrial observation plots

The locations of observational sampling plots at terrestrial sites (TOS)
are available in the <a href="http://data.neonscience.org/documents" target="_blank">document library</a> 
on the Data Portal, in the Spatial Data folder, as static files, 
in both tabular and shapefile formats. Your download will be a zip file 
containing tabular files of plot centroids and point locations, and 
shapefiles of plot centroids, point locations, and polygons.

The readme file contains descriptions for each of the columns in the 
tabular files.

```{r TOS-readme, echo=F}

rdme <- read.delim('/Users/clunch/Dropbox/NEON/spatial/All_NEON_TOS_Plots_V5/readme .csv',
                   sep=',', header=T)
rdme

```

You can use these files to navigate the spatial layout of sampling for 
TOS: mosquitoes, beetles, plants, birds, etc. In this tutorial, we'll be 
using the location data provided along with data downloads, as well as 
methods in the `geoNEON` package, to explore TOS spatial data, instead of 
these files.

## Spatial data in data downloads

### Observational data

Both aquatic and terrestrial observational data download include spatial 
data in the downloaded files. Let's take a look at the small mammal data. 
Download small mammal data from Onaqui (ONAQ), August 2018 to investigate. 
If downloading data using the `neonUtilties` package is new to you, check 
out the <a href="https://www.neonscience.org/neonDataStackR" target="_blank">neonUtilities tutorial</a>.

``` {r get-mam-data}

mam <- loadByProduct(dpID="DP1.10072.001", site="ONAQ",
                     startdate="2018-08", enddate="2018-08",
                     check.size=F)

```

The spatial data are in the `pertrapnight` table.

```{r print-mam}

head(mam$mam_pertrapnight)

```

But there's a limitation here - the latitudes and longitudes provided 
are for the plots, not for the traps. Take a look at all the data for a 
single plot to see this:

``` {r print-ONAQ019}

mam$mam_pertrapnight[which(mam$mam_pertrapnight$plotID=="ONAQ_019"),]

```

The latitude and longitude are the same for every record. This pattern 
is the same for other TOS data, the data download contains the plot-level 
coordinates.

For many analyses, this level of spatial data is sufficient! But for other 
types of analyses, you may need more precise locations. The `geoNEON` package 
can get these data for you.

The `getLocTOS()` function in the `geoNEON` package uses the NEON API to 
access NEON location data, and then makes protocol-specific calculations 
to return precise sampling locations. For more information about the NEON 
API, see the <a href="https://www.neonscience.org/neon-api-usage" target="_blank">API tutorial</a> 
and the <a href="https://data.neonscience.org/data-api" target="_blank">API web page</a>. 
For more information about the location calculations used in each data product, 
see the Data Product User Guide for each product.

The `getLocTOS()` function requires two inputs:

* A data table from a NEON TOS data product
* The NEON table name of the first input

The list of tables and data products that can be entered is in the 
<a href="https://github.com/NEONScience/NEON-geolocation/tree/master/geoNEON" target="_blank">package documentation on GitHub</a>.

For small mammals, the function call looks like this:

``` {r mam-calc}

mam.loc <- def.calc.geo.os(data=mam$mam_pertrapnight,
                           dataProd="mam_pertrapnight")

```

What columns have been added by `getLocTOS()`?

``` {r mam-diff}

names(mam.loc)[which(!names(mam.loc) %in% names(mam$mam_pertrapnight))]

```

Now we have adjusted latitude, longitude, and elevation, and the 
corresponding easting and northing. We can use the easting and northing to 
plot the locations of the mammal traps:

``` {r mam-grids}

plot(mam.loc$easting, mam.loc$northing, pch=".",
     xlab="Easting", ylab="Northing")

```

Each grid has 100 points, so even with each trap plotted as a . we can only 
see a square for each grid. Let's zoom in on a single plot:

``` {r plot-ONAQ019}

plot(mam.loc$easting[which(mam.loc$plotID=="ONAQ_019")], 
     mam.loc$northing[which(mam.loc$plotID=="ONAQ_019")], 
     pch=".", xlab="Easting", ylab="Northing")

```

Now let's add a layer of data to see which of these traps caught a mammal:

``` {r plot-captures}

points(mam.loc$easting[which(mam.loc$plotID=="ONAQ_019" & 
                               mam.loc$trapStatus=="5 - capture")], 
     mam.loc$northing[which(mam.loc$plotID=="ONAQ_019" &
                              mam.loc$trapStatus=="5 - capture")],
     pch=20, col="blue")

```

In the month of data we're viewing, in this plot, animals were caught at 
only 5 of the 100 traps.



